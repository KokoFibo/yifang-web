---
// src/components/Header.astro
import { getLangFromUrl } from "../i18n/utils.js";
import LanguagePicker from "./LanguagePicker.astro";
import { getEntry } from "astro:content";

const rawLang = getLangFromUrl(Astro.url);
const lang = rawLang === "en" || rawLang === "zh" ? rawLang : "en";

const entry = await getEntry("navigation", lang);
const nav = entry?.data || {
  home: "Home",
  companies: "Companies",
  academy: "Academy",
  career: "Career",
  blog: "Blog",
  contact: "Contact",
};

const getNavPath = (path) => {
  const cleanPath = path.startsWith("/") ? path.slice(1) : path;
  if (cleanPath === "") {
    return `/${lang}/`;
  }
  return `/${lang}/${cleanPath}`;
};
---

<header
  id="main-header"
  class="fixed top-0 left-0 right-0 z-[100] transition-all duration-500 border-b border-transparent py-3 md:py-4"
>
  <div class="mx-auto flex max-w-7xl items-center justify-between px-6">
    <a
      href={getNavPath("/")}
      class="nav-brand text-xl font-bold text-white transition-all duration-300 hover:scale-105 active:scale-95"
    >
      <img
        src="/images/yifang-logo.png"
        alt="yifang-logo"
        class="w-30 lg:w-40"
      />
    </a>

    <nav class="hidden items-center md:flex text-white">
      <ul class="flex items-center gap-2 text-sm lg:text-xl">
        <li class="group relative">
          <a
            href={getNavPath("/")}
            class="nav-link px-4 py-2 flex items-center transition-all duration-300 hover:text-red-500"
          >
            {nav.home}
          </a>
        </li>

        <li class="group relative">
          <button
            class="nav-link px-4 py-2 flex items-center gap-1 transition-all duration-300 outline-none hover:text-red-500"
          >
            {nav.companies}
            <svg
              class="w-3 h-3 transition-transform duration-300 group-hover:rotate-180"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <div
            class="absolute left-1/2 -translate-x-1/2 top-full pt-3 opacity-0 translate-y-4 pointer-events-none group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto transition-all duration-300 ease-out"
          >
            <div
              class="w-48 rounded-xl border border-slate-200 bg-white shadow-2xl p-2 overflow-hidden"
            >
              {
                ["YSM", "YCME", "YEV", "YAM"].map((item) => (
                  <a
                    href={getNavPath(`/companies/${item.toLowerCase()}`)}
                    class="block px-4 py-2.5 rounded-lg hover:bg-red-50 hover:text-red-600 hover:translate-x-1 text-slate-800 text-xs font-medium transition-all duration-200"
                  >
                    {item}
                  </a>
                ))
              }
            </div>
          </div>
        </li>

        <li class="group relative">
          <a
            href={getNavPath("/yifang-academy")}
            class="nav-link px-4 py-2 flex items-center transition-all duration-300 hover:text-red-500"
          >
            {nav.academy}
          </a>
        </li>

        <li class="group relative">
          <button
            class="nav-link px-4 py-2 flex items-center gap-1 transition-all duration-300 outline-none hover:text-red-500"
          >
            <a
              href={getNavPath("/career/career")}
              class="nav-link px-4 py-2 flex items-center transition-all duration-300 hover:text-red-500"
            >
              {nav.career}
            </a>
            <svg
              class="w-3 h-3 transition-transform duration-300 group-hover:rotate-180"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          <div
            class="absolute left-1/2 -translate-x-1/2 top-full pt-3 opacity-0 translate-y-4 pointer-events-none group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto transition-all duration-300 ease-out"
          >
            <div
              class="w-48 rounded-xl border border-slate-200 bg-white shadow-2xl p-2 overflow-hidden"
            >
              {
                ["Jobs"].map((item) => (
                  <a
                    href={getNavPath(`/career/${item.toLowerCase()}`)}
                    class="block px-4 py-2.5 rounded-lg hover:bg-red-50 hover:text-red-600 hover:translate-x-1 text-slate-800 text-xs font-medium transition-all duration-200"
                  >
                    {item}
                  </a>
                ))
              }
            </div>
          </div>
        </li>

        <li class="group relative">
          <a
            href={getNavPath("/blogs")}
            class="nav-link px-4 py-2 flex items-center transition-all duration-300 hover:text-red-500"
          >
            {nav.blog}
          </a>
        </li>

        <li class="group relative">
          <a
            href={getNavPath("/contact")}
            class="nav-link px-4 py-2 flex items-center transition-all duration-300 hover:text-red-500"
          >
            {nav.contact}
          </a>
        </li>

        <li class="ml-4">
          <LanguagePicker />
        </li>
      </ul>
    </nav>

    <button
      id="menu-btn"
      class="p-2 text-white md:hidden transition-colors duration-300 focus:outline-none active:scale-90"
    >
      <div
        id="hamburger"
        class="w-5 h-3.5 relative flex flex-col justify-between"
      >
        <span
          class="w-full h-0.5 bg-current transition-all duration-300 origin-center"
        ></span>
        <span class="w-full h-0.5 bg-current transition-all duration-300"
        ></span>
        <span
          class="w-full h-0.5 bg-current transition-all duration-300 origin-center"
        ></span>
      </div>
    </button>
  </div>

  <div
    id="mobile-menu"
    class="max-h-0 overflow-hidden bg-white md:hidden transition-all duration-500 ease-in-out shadow-2xl"
  >
  </div>
</header>

<script is:inline>
  function initNavigation() {
    const header = document.getElementById("main-header");
    const menuBtn = document.getElementById("menu-btn");
    const menu = document.getElementById("mobile-menu");
    const desktopLinks = document.querySelectorAll(".nav-link");
    const mobileLinks = document.querySelectorAll(".mobile-link");
    const hamburgerSpans = document.querySelectorAll("#hamburger span");
    const currentPath = window.location.pathname;

    function setActiveState() {
      desktopLinks.forEach((link) => {
        const href = link.getAttribute("href");
        const li = link.closest("li");

        if (!href) return;

        // Logic penentu Active:
        // 1. Jika home (/, /en/, /zh/), harus match persis agar tidak meng-underline semua page.
        // 2. Jika bukan home, gunakan startsWith agar sub-page tetap mengaktifkan menu parent.
        const isHome =
          href.endsWith("/en/") || href.endsWith("/zh/") || href === "/";
        const isActive = isHome
          ? currentPath === href
          : currentPath.startsWith(href);

        if (isActive) {
          li?.classList.add("active");
        } else {
          li?.classList.remove("active");
        }
      });

      mobileLinks.forEach((link) => {
        const href = link.getAttribute("href");
        const dot = link.querySelector(".active-dot");
        if (
          href &&
          (currentPath === href ||
            (href !== "/" && currentPath.startsWith(href)))
        ) {
          link.classList.add("text-red-600", "bg-red-50");
          if (dot) dot.style.opacity = "1";
        } else {
          link.classList.remove("text-red-600", "bg-red-50");
          if (dot) dot.style.opacity = "0";
        }
      });
    }

    // Scroll handler & Toggle menu dipertahankan sesuai kode asli
    window.addEventListener("scroll", () => {
      if (window.scrollY > 30) {
        header.classList.add(
          "bg-black/20",
          "backdrop-blur-xl",
          "border-slate-200",
          "shadow-sm",
          "py-2"
        );
        header.classList.remove("py-3", "md:py-4");
      } else {
        header.classList.remove(
          "bg-black/20",
          "backdrop-blur-xl",
          "border-slate-200",
          "shadow-sm",
          "py-2"
        );
        header.classList.add("py-3", "md:py-4");
      }
    });

    setActiveState();
  }

  initNavigation();
  document.addEventListener("astro:after-swap", initNavigation);
</script>

<style>
  .nav-link {
    position: relative;
    height: 40px;
    display: flex;
    align-items: center;
  }
  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 4px;
    left: 1rem;
    right: 1rem;
    height: 2px;
    background-color: #cc0000;
    transform: scaleX(0);
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }

  /* Underline muncul saat Hover ATAU saat class .active ada */
  .group:hover .nav-link::after,
  li.active .nav-link::after {
    transform: scaleX(1);
  }

  /* Warna merah pada teks saat menu aktif */
  li.active .nav-link {
    color: #ef4444;
  }

  header.bg-white\/90 {
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
</style>

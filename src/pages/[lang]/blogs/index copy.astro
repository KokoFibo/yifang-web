---
import HeroSection from "../../../components/HeroSection.astro";
import Layout from "../../../layouts/Layout.astro";
import BlogCard from "../../../components/BlogCard.astro";

import { getEntry, getCollection } from "astro:content";

export async function getStaticPaths() {
  return [{ params: { lang: "en" } }, { params: { lang: "zh" } }];
}

const { lang } = Astro.params;

// 1. Ambil data Hero (JSON)
const entry = await getEntry("blogs-page", lang);
if (!entry) {
  throw new Error(`Data tidak ditemukan untuk bahasa: ${lang}`);
}
const { data } = entry;

// 2. Ambil artikel (Markdown) dengan filter yang lebih aman
const allPosts = await getCollection("blog");
console.log(
  "Daftar ID artikel yang ditemukan:",
  allPosts.map((p) => p.id)
);
const sortedPosts = allPosts
  .filter((post) => post.id.startsWith(`${lang}/`)) // Filter folder bahasa
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()); // Urutkan tanggal
---

<Layout title={lang === "zh" ? "博客 | Yifang Group" : "Blogs | Yifang Group"}>
  <HeroSection
    companies={data.main.companies}
    url="/images/office-building-3.webp"
    description={data.main.description}
    button={data.main.button}
  />

  <section class="bg-bgwhite py-20">
    <div class="max-w-7xl mx-auto px-6">
      <div class="mb-12 border-l-4 border-[var(--color-accent)] pl-6">
        <h2 class="text-[var(--color-surface)] text-3xl font-bold italic">
          {lang === "zh" ? "最新文章" : "Latest Updates"}
        </h2>
      </div>

      {
        sortedPosts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {sortedPosts.map((post) => {
              // Logika Slug: ambil ID, buang folder bahasa dan ekstensi .md
              // Contoh: "en/first-post.md" -> "first-post"
              const cleanSlug = post.id.split("/")[1].replace(/\.[^/.]+$/, "");

              return (
                <BlogCard
                  title={post.data.title}
                  description={post.data.description}
                  pubDate={post.data.pubDate}
                  image={post.data.image}
                  lang={lang}
                  tags={post.data.tags}
                  lang={lang}
                  href={`/${lang}/blogs/${cleanSlug}`}
                />
              );
            })}
          </div>
        ) : (
          <div class="text-center py-20 border border-white/10 rounded-xl">
            <p class="text-[var(--color-secondary)] italic">
              {lang === "zh" ? "暂无文章" : "No articles found yet."}
            </p>
          </div>
        )
      }
    </div>
  </section>
</Layout>

<style>
  body {
    background-color: black;
  }
</style>

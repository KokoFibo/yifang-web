---
// src/pages/[lang]/blogs/index.astro
import Layout from "../../../layouts/Layout.astro";
import BlogCard from "../../../components/BlogCard.astro";
import { getCollection } from "astro:content";

// 1. Wajib ada untuk dynamic route [lang]
export async function getStaticPaths() {
  return [{ params: { lang: "en" } }, { params: { lang: "zh" } }];
}

const { lang } = Astro.params;

// 2. Ambil semua artikel berdasarkan bahasa
const allPosts = await getCollection("blog");
const sortedPosts = allPosts
  .filter((post) => post.id.startsWith(`${lang}/`))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 3. Ambil daftar tag unik untuk filter
const uniqueTags = [...new Set(sortedPosts.flatMap((post) => post.data.tags))];

const t = {
  search: lang === "zh" ? "搜索文章..." : "Search articles...",
  noResult: lang === "zh" ? "未找到相关文章" : "No articles found.",
  all: lang === "zh" ? "全部" : "All",
};
---

<Layout title="Blog | Yifang Group">
  <div class="h-24 bg-black w-full fixed top-0 z-40 shadow-md"></div>

  <main class="bg-white min-h-screen pt-40 pb-20 text-slate-900">
    <div class="max-w-7xl mx-auto px-6">
      <div
        class="flex flex-col md:flex-row md:items-end justify-between gap-8 mb-12"
      >
        <div>
          <h1
            class="text-4xl md:text-5xl font-bold text-slate-900 mb-2 italic tracking-tight"
          >
            Blog & News
          </h1>
          <p class="text-slate-500 font-medium tracking-wide uppercase text-sm">
            Yifang Group Insights & Updates
          </p>
        </div>

        <div class="relative w-full md:w-96">
          <input
            type="text"
            id="search-input"
            placeholder={t.search}
            class="w-full pl-12 pr-4 py-3 rounded-xl border border-slate-200 focus:border-[var(--color-primary)] focus:ring-1 focus:ring-[var(--color-primary)] outline-none transition-all shadow-sm bg-slate-50/50"
          />
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5 absolute left-4 top-3.5 text-slate-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mb-12" id="tag-filters">
        <button
          class="tag-btn px-5 py-2 rounded-lg border border-slate-200 text-sm font-bold transition-all cursor-pointer"
          data-tag="all"
          data-active="true"
        >
          {t.all}
        </button>
        {
          uniqueTags.map((tag) => (
            <button
              class="tag-btn px-5 py-2 rounded-lg border border-slate-200 text-sm font-bold text-slate-500 transition-all hover:border-[var(--color-primary)] cursor-pointer"
              data-tag={tag}
              data-active="false"
            >
              {tag}
            </button>
          ))
        }
      </div>

      <div
        id="blog-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
      >
        {
          sortedPosts.map((post) => (
            <div
              class="post-item"
              data-title={post.data.title.toLowerCase()}
              data-tags={JSON.stringify(post.data.tags)}
            >
              <BlogCard
                title={post.data.title}
                description={post.data.description}
                pubDate={post.data.pubDate}
                image={post.data.image}
                tags={post.data.tags}
                lang={lang}
                href={`/${lang}/blogs/${post.id.split("/")[1].replace(/\.[^/.]+$/, "")}`}
              />
            </div>
          ))
        }
      </div>

      <div
        id="no-results"
        class="hidden text-center py-24 border-2 border-dashed border-slate-100 rounded-3xl"
      >
        <p class="text-slate-400 italic text-lg">{t.noResult}</p>
      </div>

      <div
        id="pagination-controls"
        class="flex justify-center items-center gap-6 mt-20 pt-10 border-t border-slate-50"
      >
        <button
          id="prev-btn"
          class="p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors disabled:opacity-20 cursor-pointer"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path></svg
          >
        </button>

        <div class="flex items-center gap-2">
          <span
            id="current-page-display"
            class="text-lg font-bold text-[var(--color-primary)]">1</span
          >
          <span class="text-slate-300">/</span>
          <span id="total-pages-display" class="text-slate-500 font-medium"
            >1</span
          >
        </div>

        <button
          id="next-btn"
          class="p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors disabled:opacity-20 cursor-pointer"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            ><path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"></path></svg
          >
        </button>
      </div>
    </div>
  </main>
</Layout>

<style is:global>
  /* Styling khusus untuk tombol aktif tanpa @apply */
  .tag-btn[data-active="true"] {
    background-color: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
    color: white !important;
    box-shadow: 0 10px 15px -3px rgba(198, 42, 39, 0.2);
  }
</style>

<script>
  const ITEMS_PER_PAGE = 9;
  let currentPage = 1;
  let activeTag = "all";
  let searchQuery = "";

  const grid = document.getElementById("blog-grid");
  const items = Array.from(
    document.querySelectorAll(".post-item")
  ) as HTMLElement[];
  const noResults = document.getElementById("no-results");
  const searchInput = document.getElementById(
    "search-input"
  ) as HTMLInputElement;
  const tagBtns = document.querySelectorAll(".tag-btn");
  const currentPageDisplay = document.getElementById("current-page-display");
  const totalPagesDisplay = document.getElementById("total-pages-display");
  const prevBtn = document.getElementById("prev-btn") as HTMLButtonElement;
  const nextBtn = document.getElementById("next-btn") as HTMLButtonElement;

  function updateDisplay() {
    // 1. Filter Logic
    const filteredItems = items.filter((item) => {
      const title = item.getAttribute("data-title") || "";
      const tags = JSON.parse(item.getAttribute("data-tags") || "[]");
      return (
        title.includes(searchQuery) &&
        (activeTag === "all" || tags.includes(activeTag))
      );
    });

    // 2. Tampilan jika kosong
    if (filteredItems.length === 0) {
      if (grid) grid.style.display = "none";
      noResults?.classList.remove("hidden");
      (
        document.getElementById("pagination-controls") as HTMLElement
      ).style.display = "none";
      return;
    } else {
      if (grid) grid.style.display = "grid";
      noResults?.classList.add("hidden");
      (
        document.getElementById("pagination-controls") as HTMLElement
      ).style.display = "flex";
    }

    // 3. Pagination Logic
    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;

    items.forEach((item) => (item.style.display = "none"));
    filteredItems.slice(start, end).forEach((item) => {
      item.style.display = "block";
    });

    // 4. Update UI
    if (currentPageDisplay)
      currentPageDisplay.innerText = currentPage.toString();
    if (totalPagesDisplay) totalPagesDisplay.innerText = totalPages.toString();
    if (prevBtn) prevBtn.disabled = currentPage === 1;
    if (nextBtn) nextBtn.disabled = currentPage === totalPages;
  }

  // Listener untuk Search
  searchInput?.addEventListener("input", (e) => {
    searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
    currentPage = 1;
    updateDisplay();
  });

  // Listener untuk Filter Tags
  tagBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      tagBtns.forEach((b) => b.setAttribute("data-active", "false"));
      btn.setAttribute("data-active", "true");
      activeTag = btn.getAttribute("data-tag") || "all";
      currentPage = 1;
      updateDisplay();
    });
  });

  // Listener untuk Navigasi
  prevBtn?.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      updateDisplay();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });

  nextBtn?.addEventListener("click", () => {
    const totalFiltered = items.filter((item) => {
      const title = item.getAttribute("data-title") || "";
      const tags = JSON.parse(item.getAttribute("data-tags") || "[]");
      return (
        title.includes(searchQuery) &&
        (activeTag === "all" || tags.includes(activeTag))
      );
    }).length;

    if (currentPage < Math.ceil(totalFiltered / ITEMS_PER_PAGE)) {
      currentPage++;
      updateDisplay();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  });

  // Inisialisasi
  updateDisplay();
</script>

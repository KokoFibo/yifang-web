---
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import "../styles/global.css";
import { getLangFromUrl } from "../i18n/utils.js";

const lang = getLangFromUrl(Astro.url);

const {
  title,
  description = "Official website of Yifang Group",
  image = "/images/og-default.jpg",
  noindex = false,
} = Astro.props;

const siteName = "Yifang Group";
const siteUrl = "https://yifang.co.id";
const currentUrl = new URL(Astro.url.pathname, siteUrl).href;

// Font class
const fontClass = lang === "zh" ? "font-chinese" : "";

// hreflang helper
const baseUrl = "https://www.yifang.co.id";
const currentPath = Astro.url.pathname;

// const getAlternatePath = (targetLang) =>
//   currentPath.replace(/^\/[^\/]+/, `/${targetLang}`);

const getAlternatePath = (targetLang) => {
  // 1. Pastikan path tidak kosong dan handle root
  if (currentPath === "/" || currentPath === "") {
    return `${baseUrl}/${targetLang}/`;
  }

  // 2. Gunakan regex yang lebih aman untuk menangkap bagian bahasa
  // Ini mengganti /id/halaman menjadi /en/halaman
  let newPath = currentPath.replace(/^\/([^\/]+)/, `/${targetLang}`);

  // 3. Pastikan URL berakhir dengan slash (Trailing Slash)
  // agar konsisten dengan standar default Astro
  if (!newPath.endsWith("/")) {
    newPath += "/";
  }

  return `${baseUrl}${newPath}`;
};
---

<!doctype html>
<html lang={lang} class={fontClass}>
  <head>
    <!-- Basic -->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta name="description" content={description} />
    <meta
      name="robots"
      content={noindex ? "noindex,nofollow" : "index,follow"}
    />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <!-- Title -->
    <!-- <title>{title ? `${title} | ${siteName}` : siteName}</title> -->
    <title>{title ? `${title}` : siteName}</title>

    <!-- Canonical -->
    <link rel="canonical" href={currentUrl} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={image} />
    <meta property="og:url" content={currentUrl} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={image} />

    <!-- Hreflang -->
    <link rel="alternate" hreflang="en" href={getAlternatePath("en")} />
    <link rel="alternate" hreflang="zh" href={getAlternatePath("zh")} />
    <link rel="alternate" hreflang="x-default" href="/en/" />

    <!-- Icons -->
    <link rel="icon" href="/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Schema: Organization -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Yifang Group",
        "url": "https://yifang.co.id",
        "logo": "https://yifang.co.id/images/logo.png",
        "sameAs": []
      }
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WT79DVZYQ8"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-WT79DVZYQ8");
    </script>
  </head>

  <body class="min-h-screen">
    <Header />
    <main>
      <slot />
    </main>
    <Footer />
  </body>
</html>
